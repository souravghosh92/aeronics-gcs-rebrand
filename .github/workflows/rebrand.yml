name: Build Aeronics GCS from QGC source (Android, Qt 5.15.2)

on:
  workflow_dispatch:
    inputs:
      QGC_REPO:
        description: "QGroundControl repo to build"
        required: true
        default: "mavlink/qgroundcontrol"
      QGC_REF:
        description: "Branch/tag (use v5.0.6 to match your APK)"
        required: true
        default: "v5.0.6"
      APP_NAME:
        description: "Visible app name"
        required: true
        default: "Aeronics GCS"
      ICON_PATH:
        description: "512x512 PNG in your repo (launcher icon)"
        required: true
        default: "branding/aeronics_icon_512.png"
      INAPP_LOGO:
        description: "In-app logo PNG (transparent). If missing, ICON_PATH is used."
        required: false
        default: "branding/overrides/assets/qml/images/aeronics_logo.png"
      PACKAGE_ID:
        description: "(Optional) New package id, e.g. in.aeronics.gcs (leave blank to keep default)"
        required: false
        default: ""

jobs:
  android:
    runs-on: ubuntu-22.04

    env:
      # QGC v5.x expects Qt 5 and NDK r21d
      QT_VERSION: "5.15.2"
      ANDROID_SDK_ROOT: ${{ github.workspace }}/android-sdk
      ANDROID_NDK_VERSION: "21.4.7075529"
      JAVA_HOME: /usr/lib/jvm/temurin-17-jdk-amd64

    steps:
      - name: Checkout branding repo (this repo)
        uses: actions/checkout@v4

      - name: Install build deps
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip git build-essential ninja-build ccache wget jq p7zip-full imagemagick

      # ---- Android SDK / cmdline-tools (robust install) ----
      - name: Install Android SDK + cmdline-tools
        run: |
          set -e
          mkdir -p "$ANDROID_SDK_ROOT/cmdline-tools"
          cd "$ANDROID_SDK_ROOT"
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -O cmdtools.zip
          unzip -q cmdtools.zip -d cmdline-tools-tmp
          rm -f cmdtools.zip
          mv cmdline-tools-tmp/cmdline-tools "$ANDROID_SDK_ROOT/cmdline-tools/latest"
          rm -rf cmdline-tools-tmp
          yes | $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --licenses
          yes | $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager \
            "platform-tools" "platforms;android-34" "build-tools;34.0.0" "ndk;${{ env.ANDROID_NDK_VERSION }}"

      # ---- Qt 5.15.2 (install host tools and Android) ----
      - name: Install Qt host (Linux desktop tools incl. androiddeployqt)
        id: qt-host
        uses: jurplel/install-qt-action@v3
        with:
          version: ${{ env.QT_VERSION }}
          host: linux
          target: desktop
          arch: gcc_64

      - name: Install Qt for Android (Qt 5.15.2 full)
        id: qt-android
        uses: jurplel/install-qt-action@v3
        with:
          version: ${{ env.QT_VERSION }}
          host: linux
          target: android

      - name: Fetch QGroundControl source
        run: |
          set -e
          git clone --recursive https://github.com/${{ github.event.inputs.QGC_REPO }}.git qgc
          cd qgc
          git fetch --all --tags
          git checkout "${{ github.event.inputs.QGC_REF }}"
          git submodule update --init --recursive
          ls -la

      - name: Apply Aeronics branding to source
        run: |
          set -e
          APPNAME="${{ github.event.inputs.APP_NAME }}"
          INAPP="${{ github.event.inputs.INAPP_LOGO }}"
          ICON="${{ github.event.inputs.ICON_PATH }}"
          [ -f "$ICON" ] || { echo "::error ::ICON_PATH not found: $ICON"; exit 1; }
          if [ ! -f "$INAPP" ]; then INAPP="$ICON"; fi

          # 1) Android manifest: app label + optional package id
          sed -i 's/android:label="[^"]*"/android:label="@string\/app_name"/' qgc/android/AndroidManifest.xml || true
          if [ -n "${{ github.event.inputs.PACKAGE_ID }}" ]; then
            sed -i 's/package="\([^"]*\)"/package="${{ github.event.inputs.PACKAGE_ID }}"/' qgc/android/AndroidManifest.xml || true
          fi
          mkdir -p qgc/resources/strings
          cat > qgc/resources/strings/strings_aeronics.xml <<EOF
          <resources>
            <string name="app_name">${APPNAME}</string>
          </resources>
          EOF

          # 2) In-app icons used by QML/menus
          mkdir -p qgc/resources/icons
          cp "$INAPP" qgc/resources/icons/aeronics_logo.png
          for f in qgc_logo_full.png qground_toolbar_logo.png qgc_splash.png appbar_logo.png about_logo.png title_logo.png; do
            if [ -f "qgc/resources/icons/$f" ]; then
              cp "$INAPP" "qgc/resources/icons/$f"
            fi
          done

          # 3) Launcher mipmaps
          mkdir -p qgc/android/res/mipmap-{mdpi,hdpi,xhdpi,xxhdpi,xxxhdpi}
          convert "$ICON" -resize 48x48   qgc/android/res/mipmap-mdpi/ic_launcher.png
          convert "$ICON" -resize 72x72   qgc/android/res/mipmap-hdpi/ic_launcher.png
          convert "$ICON" -resize 96x96   qgc/android/res/mipmap-xhdpi/ic_launcher.png
          convert "$ICON" -resize 144x144 qgc/android/res/mipmap-xxhdpi/ic_launcher.png
          convert "$ICON" -resize 192x192 qgc/android/res/mipmap-xxxhdpi/ic_launcher.png
          for d in mdpi hdpi xhdpi xxhdpi xxxhdpi; do
            cp qgc/android/res/mipmap-$d/ic_launcher.png qgc/android/res/mipmap-$d/ic_launcher_round.png
          done

          # 4) Brand text in QML
          grep -RIl --null -e 'QGroundControl' qgc | xargs -0 -r sed -i "s/QGroundControl/${APPNAME}/g"

      - name: Configure (Qt 5 + Android)
        env:
          ANDROID_NDK_ROOT: ${{ env.ANDROID_SDK_ROOT }}/ndk/${{ env.ANDROID_NDK_VERSION }}
          CMAKE_PREFIX_PATH: ${{ steps.qt-android.outputs.QT_INSTALL_DIR }}
        run: |
          set -e
          mkdir -p build-android
          cd build-android
          cmake ../qgc -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DANDROID_ABI=arm64-v8a \
            -DANDROID_PLATFORM=android-24 \
            -DQT_HOST_PATH=${{ steps.qt-host.outputs.QT_INSTALL_DIR }} \
            -DQt5_DIR=${{ steps.qt-android.outputs.QT_INSTALL_DIR }}/lib/cmake/Qt5 \
            -DQT_ANDROID_SDK_ROOT=${{ env.ANDROID_SDK_ROOT }} \
            -DQT_ANDROID_NDK_ROOT=${{ env.ANDROID_SDK_ROOT }}/ndk/${{ env.ANDROID_NDK_VERSION }}
          ninja

      - name: Package APK (androiddeployqt from Qt5 host)
        env:
          PATH: ${{ steps.qt-host.outputs.QT_INSTALL_DIR }}/bin:${{ env.PATH }}
        run: |
          set -e
          cd build-android
          APP_JSON=$(find . -name "*-android_deployment_settings.json" | head -n1)
          [ -n "$APP_JSON" ] || { echo "::error ::android_deployment_settings.json not found"; exit 1; }
          androiddeployqt --input "$APP_JSON" --output ./android-build --deployment bundled --gradle --release
          find . -name "*.apk" -type f -print

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: Aeronics-GCS-from-source
          path: "**/*.apk"
